<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of loadTrials</title>
  <meta name="keywords" content="loadTrials">
  <meta name="description" content="loadTrials  generates rawTrialData instances for each trial">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003-2019 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">gui</a> &gt; <a href="index.html">importc3d</a> &gt; loadTrials.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for gui/importc3d&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>loadTrials
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>loadTrials  generates rawTrialData instances for each trial</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function trials=loadTrials(trialMD,fileList,secFileList,info) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">loadTrials  generates rawTrialData instances for each trial

INPUTS:
trialMD: cell array of trailMetaData objects where the cell index corresponds
to the trial number
fileList: list of .c3d files containing kinematic and force data for a given experiment
secFileList: list of files containing EMG data for a given experiment
info: structured array output from GetInfoGUI

OUTPUT:
trials: cell array of rawTrialData objects where the cell index corresponds
to the trial number

See also: rawTrialData</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="addMarkerPair.html" class="code" title="function addMarkerPair(correctLabel,altLabel)">addMarkerPair</a>	</li><li><a href="findLabel.html" class="code" title="function markerLabel=findLabel(viconLabel)">findLabel</a>	function to deal with different marker labels from vicon. For the code to</li><li><a href="getEMGworksdata.html" class="code" title="function [analogsNexus, EMGList, relData, relData2,secondFile,analogsInfo2,emptyChannels1,emptyChannels2,EMGList1,EMGList2]=getEMGworksdata(infoEMGList1 ,infoEMGList2 ,secFileList,fileList, NexusfileList)">getEMGworksdata</a>	get EMG from EMGworks</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="loadSubject.html" class="code" title="function [expData,rawExpData,adaptData]=loadSubject(info,eventClass)">loadSubject</a>	loadSubject  Load, organize, process, and save data from .c3d files as a</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function trials=loadTrials(trialMD,fileList,secFileList,info)</a>
0002 <span class="comment">%loadTrials  generates rawTrialData instances for each trial</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%INPUTS:</span>
0005 <span class="comment">%trialMD: cell array of trailMetaData objects where the cell index corresponds</span>
0006 <span class="comment">%to the trial number</span>
0007 <span class="comment">%fileList: list of .c3d files containing kinematic and force data for a given experiment</span>
0008 <span class="comment">%secFileList: list of files containing EMG data for a given experiment</span>
0009 <span class="comment">%info: structured array output from GetInfoGUI</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%OUTPUT:</span>
0012 <span class="comment">%trials: cell array of rawTrialData objects where the cell index corresponds</span>
0013 <span class="comment">%to the trial number</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%See also: rawTrialData</span>
0016 
0017 <span class="comment">%orientationInfo(offset,foreaftAx,sideAx,updownAx,foreaftSign,sideSign,updownSign)</span>
0018 orientation=orientationInfo([0,0,0],<span class="string">'y'</span>,<span class="string">'x'</span>,<span class="string">'z'</span>,1,1,1); <span class="comment">%check signs! For use in biomechanics calculations</span>
0019 
0020 <span class="comment">%Create list of expected/accepted muscles:</span>
0021 orderedMuscleList={<span class="string">'PER'</span>,<span class="string">'TA'</span>,<span class="string">'TAP'</span>,<span class="string">'TAD'</span>,<span class="string">'SOL'</span>,<span class="string">'MG'</span>,<span class="string">'LG'</span>,<span class="string">'RF'</span>,<span class="string">'VM'</span>,<span class="string">'VL'</span>,<span class="string">'BF'</span>,<span class="string">'SEMB'</span>,<span class="string">'SEMT'</span>,<span class="string">'ADM'</span>,<span class="string">'GLU'</span>,<span class="string">'TFL'</span>,<span class="string">'ILP'</span>,<span class="string">'SAR'</span>,<span class="string">'HIP'</span>}; <span class="comment">%This is the desired order</span>
0022 orderedEMGList={};
0023 <span class="keyword">for</span> j=1:length(orderedMuscleList)
0024     orderedEMGList{end+1}=[<span class="string">'R'</span> orderedMuscleList{j}];
0025     orderedEMGList{end+1}=[<span class="string">'L'</span> orderedMuscleList{j}];
0026 <span class="keyword">end</span>
0027 
0028 <span class="keyword">for</span> t=cell2mat(info.trialnums) <span class="comment">%loop through each trial</span>
0029     <span class="comment">%Import data from c3d, uses external toolbox BTK</span>
0030     H=btkReadAcquisition([fileList{t} <span class="string">'.c3d'</span>]);
0031     [analogs,analogsInfo]=btkGetAnalogs(H);
0032     secondFile=false;
0033     <span class="keyword">if</span> ~isempty(secFileList{t})
0034         H2=btkReadAcquisition([secFileList{t} <span class="string">'.c3d'</span>]);
0035         [analogs2,analogsInfo2]=btkGetAnalogs(H2);
0036         secondFile=true;
0037     <span class="keyword">end</span>
0038 
0039     <span class="comment">%% GRFData</span>
0040     <span class="keyword">if</span> info.forces <span class="comment">%check to see if there are GRF forces in the trial</span>
0041         showWarning = false;<span class="comment">%must define or else error is thrown when otherwise case is skipped</span>
0042         relData=[];
0043         forceLabels ={};
0044         units={};
0045         fieldList=fields(analogs);
0046         fL=cellfun(@(x) ~isempty(x),regexp(fieldList,<span class="string">'^Raw'</span>));
0047         ttt=fieldList(fL);
0048         raws=[];
0049         <span class="keyword">for</span> i=1:length(ttt)
0050             raws=[raws analogs.(ttt{i})];
0051         <span class="keyword">end</span>
0052         raws=zscore(raws);
0053         <span class="keyword">for</span> j=1:length(fieldList);<span class="comment">%parse analog channels by force, moment, cop</span>
0054             <span class="comment">%if strcmp(fieldList{j}(end-2),'F') || strcmp(fieldList{j}(end-2),'M') %Getting fields that end in F.. or M.. only</span>
0055             <span class="keyword">if</span> strcmp(fieldList{j}(1),<span class="string">'F'</span>) || strcmp(fieldList{j}(1),<span class="string">'M'</span>) || ~isempty(strfind(fieldList{j},<span class="string">'Force'</span>)) || ~isempty(strfind(fieldList{j},<span class="string">'Moment'</span>))
0056                 <span class="keyword">if</span> ~strcmpi(<span class="string">'x'</span>,fieldList{j}(end-1)) &amp;&amp; ~strcmpi(<span class="string">'y'</span>,fieldList{j}(end-1)) &amp;&amp; ~strcmpi(<span class="string">'z'</span>,fieldList{j}(end-1))
0057                     warning([<span class="string">'loadTrials:GRFs'</span>,<span class="string">'Found force/moment data that does not correspond to any of the expected directions (x,y or z). Discarding channel '</span> fieldList{j}])
0058                 <span class="keyword">else</span>
0059                     <span class="keyword">switch</span> fieldList{j}(end)<span class="comment">%parse devices</span>
0060                         <span class="keyword">case</span> <span class="string">'1'</span> <span class="comment">%Forces/moments ending in '1' area assumed to be of left treadmill belt</span>
0061                             forceLabels{end+1} = [<span class="string">'L'</span>,fieldList{j}(end-2:end-1)];
0062                             units{end+1}=eval([<span class="string">'analogsInfo.units.'</span>,fieldList{j}]);
0063                             relData=[relData,analogs.(fieldList{j})];
0064                         <span class="keyword">case</span> <span class="string">'2'</span> <span class="comment">%Forces/moments ending in '2' area assumed to be of right treadmill belt</span>
0065                             forceLabels{end+1} = [<span class="string">'R'</span>,fieldList{j}(end-2:end-1)];
0066                             units{end+1}=eval([<span class="string">'analogsInfo.units.'</span>,fieldList{j}]);
0067                             relData=[relData,analogs.(fieldList{j})];
0068                         <span class="keyword">case</span> <span class="string">'3'</span> <span class="comment">%Forces/moments ending in '4' area assumed to be of handrail %NIV</span>
0069                             forceLabels{end+1} = [<span class="string">'H'</span>,fieldList{j}(end-2:end-1)];
0070                             units{end+1}=eval([<span class="string">'analogsInfo.units.'</span>,fieldList{j}]);
0071                             relData=[relData,analogs.(fieldList{j})];
0072 
0073                         <span class="keyword">case</span> <span class="string">'4'</span> <span class="comment">%Other forceplate, loading just in case</span>
0074                             forceLabels{end+1} = [<span class="string">'FP4'</span>,fieldList{j}(end-2:end-1)];
0075                             units{end+1}=eval([<span class="string">'analogsInfo.units.'</span>,fieldList{j}]);
0076                             relData=[relData,analogs.(fieldList{j})];
0077                         <span class="keyword">case</span> <span class="string">'5'</span> <span class="comment">%Other forceplate, loading just in case</span>
0078                             forceLabels{end+1} = [<span class="string">'FP5'</span>,fieldList{j}(end-2:end-1)];
0079                             units{end+1}=eval([<span class="string">'analogsInfo.units.'</span>,fieldList{j}]);
0080                             relData=[relData,analogs.(fieldList{j})];
0081                         <span class="keyword">case</span> <span class="string">'6'</span> <span class="comment">%Other forceplate, loading just in case</span>
0082                             forceLabels{end+1} = [<span class="string">'FP6'</span>,fieldList{j}(end-2:end-1)];
0083                             units{end+1}=eval([<span class="string">'analogsInfo.units.'</span>,fieldList{j}]);
0084                             relData=[relData,analogs.(fieldList{j})];
0085                         <span class="keyword">case</span> <span class="string">'7'</span> <span class="comment">%Other forceplate, loading just in case</span>
0086                             forceLabels{end+1} = [<span class="string">'FP7'</span>,fieldList{j}(end-2:end-1)];
0087                             units{end+1}=eval([<span class="string">'analogsInfo.units.'</span>,fieldList{j}]);
0088                             relData=[relData,analogs.(fieldList{j})];
0089 
0090                         <span class="keyword">otherwise</span>
0091                             showWarning=true;<span class="comment">%%HH moved warning outside loop on 6/3/2015 to reduce command window output</span>
0092                     <span class="keyword">end</span>
0093                     analogs=rmfield(analogs,fieldList{j}); <span class="comment">%Just to save memory space</span>
0094                 <span class="keyword">end</span>
0095             <span class="keyword">end</span>
0096         <span class="keyword">end</span>
0097         <span class="keyword">if</span> showWarning
0098             warning([<span class="string">'loadTrials:GRFs'</span>,<span class="string">'Found force/moment data in trial '</span> num2str(t) <span class="string">' that does not correspond to any of the expected channels (L=1, R=2, H=4). Data discarded.'</span>])
0099         <span class="keyword">end</span>
0100 
0101         <span class="comment">%Sanity check: offset calibration, make sure that force values from</span>
0102         <span class="comment">%analog pins have zero mode, correct scale units etc.</span>
0103         <span class="keyword">try</span>
0104             <span class="comment">%map=[1:6,8:13,46:51]; %Forces and moments to the corresponding pin in. -This list is not current. Pablo, 22/11/2019.</span>
0105             list={<span class="string">'LFx'</span>,<span class="string">'LFy'</span>,<span class="string">'LFz'</span>,<span class="string">'LMx'</span>,<span class="string">'LMy'</span>,<span class="string">'LMz'</span>,<span class="string">'RFx'</span>,<span class="string">'RFy'</span>,<span class="string">'RFz'</span>,<span class="string">'RMx'</span>,<span class="string">'RMy'</span>,<span class="string">'RMz'</span>,<span class="string">'HFx'</span>,<span class="string">'HFy'</span>,<span class="string">'HFz'</span>,<span class="string">'HMx'</span>,<span class="string">'HMy'</span>,<span class="string">'HMz'</span>};
0106             offset=nan(size(list));
0107             gain=nan(size(list));
0108             trueOffset=nan(size(list));
0109             differenceInForceUnits=nan(size(list));
0110             m=nan(size(list));
0111             tol=10; <span class="comment">%N or N.m</span>
0112             <span class="keyword">for</span> j=1:length(list)
0113                 k=find(strcmp(forceLabels,list{j}));
0114                 <span class="keyword">if</span> ~isempty(k)
0115                     aux=fields(analogs);
0116                     <span class="comment">%idx=num2str(map(k)); %Hardcoded map of input pins to</span>
0117                     <span class="comment">%forces/moments. Outdated.</span>
0118                     [~,idx]=max(abs(relData(:,k)'*raws));
0119                     idx=ttt{idx}(end);
0120                     iii=find(cellfun(@(x) ~isempty(x),regexp(aux,[<span class="string">'Pin_'</span> idx <span class="string">'$'</span>])));
0121                     raw=analogs.(aux{iii});
0122                     proc=relData(:,k);
0123                     <span class="comment">% figure; plot(raw,proc,'.') % Finally found were the</span>
0124                     <span class="comment">% plots in the c3d2mat process were coming from</span>
0125                     rel=find(proc~=0);
0126                     <span class="keyword">if</span> ~isempty(rel)
0127                         m(j)=4*prctile(abs(proc(rel)),1); <span class="comment">%This can be used for thresholding</span>
0128                         coef=polyfit(raw(rel),proc(rel),1);
0129                         gain(j)=coef(1); <span class="comment">%This could be rounded to keep only 2 significant figures, which is the more likely value</span>
0130                         offset(j)=-coef(2)/coef(1);
0131                         C=[-1:.001:1];
0132                         Hh=hist(raw,C);
0133                         trueOffset(j)=C(Hh==max(Hh));
0134                         differenceInForceUnits(j)=gain(j)*(trueOffset(j)-offset(j));
0135                     <span class="keyword">end</span>
0136                     <span class="keyword">switch</span> list{j}(2)
0137                         <span class="keyword">case</span> <span class="string">'F'</span> <span class="comment">%Forces</span>
0138                             ttol=tol;
0139                             units=<span class="string">'N'</span>;
0140                         <span class="keyword">case</span> <span class="string">'M'</span> <span class="comment">%Moments</span>
0141                             ttol=tol*1000; <span class="comment">%moments are in N.mm</span>
0142                             units=<span class="string">'N.mm'</span>;
0143                         <span class="keyword">otherwise</span>
0144                             error(<span class="string">''</span>);
0145                     <span class="keyword">end</span>
0146                     <span class="keyword">if</span> differenceInForceUnits(j)&gt;ttol
0147                         <span class="comment">% figure % Commented out by MGR 01/24/24</span>
0148                         <span class="comment">% hold on</span>
0149                         <span class="comment">% plot(raw(rel),proc(rel),'.')</span>
0150                         <span class="comment">% plot([-.01 .01],([-.01 .01]+offset(j))*gain(j))</span>
0151                         <span class="comment">% hold off</span>
0152                         <span class="comment">%a=questdlg(['When loading ' list{j} ' there appears to be a non-zero mode (offset). Calculated offset is ' num2str(differenceInForceUnits(j)) ' ' units '. Please confirm that you want to subtract this offset.']);</span>
0153                         a=<span class="string">'No'</span>;
0154                         <span class="keyword">switch</span> a
0155                             <span class="keyword">case</span> <span class="string">'Yes'</span>
0156                                 relData(:,k)=gain(j)*(raw -trueOffset(j));
0157                                 relData(abs(relData(:,k))&lt;4*ttol,k)=0; <span class="comment">%Thresholding using the tolerance, should never be less than 2*ttol</span>
0158                             <span class="keyword">case</span> <span class="string">'No'</span>
0159                                 <span class="comment">%nop</span>
0160                             <span class="keyword">otherwise</span>
0161                                 error(<span class="string">''</span>);
0162                         <span class="keyword">end</span>
0163                     <span class="keyword">end</span>
0164                 <span class="keyword">end</span>
0165             <span class="keyword">end</span>
0166         <span class="keyword">catch</span> ME
0167             warning(<span class="string">'loadTrials:GRFs'</span>,<span class="string">'Could not perform offset check. Proceeding with data as is.'</span>)
0168         <span class="keyword">end</span>
0169 
0170         <span class="comment">%Create labTimeSeries (data,t0,Ts,labels,orientation)</span>
0171         <span class="keyword">if</span> size(relData,2)&lt;12 <span class="comment">%we don't have at least 3 forces and 3 moments per belt</span>
0172             warning(<span class="string">'loadTrials:GRFs'</span>,[<span class="string">'Did not find all GRFs for the two belts in trial '</span> num2str(t)])
0173         <span class="keyword">end</span>
0174         GRFData=orientedLabTimeSeries(relData,0,1/analogsInfo.frequency,forceLabels,orientation);
0175         GRFData.DataInfo.Units=units;
0176     <span class="keyword">else</span>
0177         GRFData=[];
0178     <span class="keyword">end</span>
0179     clear relData* raws
0180 
0181     <span class="comment">%% EMGData (from 2 files!) &amp; Acceleration data</span>
0182     <span class="keyword">if</span> info.EMGs
0183         <span class="comment">%Primary file (PC)</span>
0184         <span class="keyword">if</span>  info.Nexus==1
0185             relData=[];
0186             relDataTemp=[];
0187             fieldList=fields(analogs);
0188             idxList=[];
0189             <span class="keyword">for</span> j=1:length(fieldList);
0190                 <span class="keyword">if</span>  ~isempty(strfind(fieldList{j},<span class="string">'EMG'</span>))  <span class="comment">%Getting fields that start with 'EMG' only</span>
0191                     relDataTemp=[relDataTemp,analogs.(fieldList{j})];
0192                     idxList(end+1)=str2num(fieldList{j}(strfind(fieldList{j},<span class="string">'EMG'</span>)+3:end));
0193                     analogs=rmfield(analogs,fieldList{j}); <span class="comment">%Just to save memory space</span>
0194                 <span class="keyword">end</span>
0195             <span class="keyword">end</span>
0196             emptyChannels1=cellfun(@(x) isempty(x),info.EMGList1);
0197             EMGList1=info.EMGList1(~emptyChannels1);
0198             relData(:,idxList)=relDataTemp; <span class="comment">%Re-sorting to fix the 1,10,11,...,2,3 count that Matlab does</span>
0199             relData=relData(:,~emptyChannels1);
0200             EMGList=EMGList1;
0201 
0202             <span class="comment">%Secondary file (PC)</span>
0203             relDataTemp2=[];
0204             idxList2=[];
0205             <span class="keyword">if</span> secondFile
0206                 fieldList=fields(analogs2);
0207                 <span class="keyword">for</span> j=1:length(fieldList);
0208                     <span class="keyword">if</span>  ~isempty(strfind(fieldList{j},<span class="string">'EMG'</span>))  <span class="comment">%Getting fields that start with 'EMG' only</span>
0209                         relDataTemp2=[relDataTemp2,analogs2.(fieldList{j})];
0210                         idxList2(end+1)=str2num(fieldList{j}(strfind(fieldList{j},<span class="string">'EMG'</span>)+3:end));
0211                         analogs2=rmfield(analogs2,fieldList{j}); <span class="comment">%Just to save memory space</span>
0212                     <span class="keyword">end</span>
0213                 <span class="keyword">end</span>
0214                 emptyChannels2=cellfun(@(x) isempty(x),info.EMGList2);
0215                 EMGList2=info.EMGList2(~emptyChannels2); <span class="comment">%Just using the names for the channels that were actually in the file</span>
0216                 relData2(:,idxList2)=relDataTemp2; <span class="comment">%Re-sorting to fix the 1,10,11,...,2,3 count that Matlab does</span>
0217                 relData2=relData2(:,~emptyChannels2);
0218                 EMGList=[EMGList1,EMGList2];
0219             <span class="keyword">end</span>
0220         <span class="keyword">elseif</span> info.EMGworks==1
0221 
0222             [analogs, EMGList, relData, relData2,secondFile,analogsInfo2,emptyChannels1,emptyChannels2,EMGList1,EMGList2]=<a href="getEMGworksdata.html" class="code" title="function [analogsNexus, EMGList, relData, relData2,secondFile,analogsInfo2,emptyChannels1,emptyChannels2,EMGList1,EMGList2]=getEMGworksdata(infoEMGList1 ,infoEMGList2 ,secFileList,fileList, NexusfileList)">getEMGworksdata</a>(info.EMGList1 ,info.EMGList2 ,info.secEMGworksdir_location,info.EMGworksdir_location,fileList{t});
0223         <span class="keyword">end</span>
0224         <span class="comment">%Check if names match with expectation, otherwise query user</span>
0225         <span class="keyword">for</span> k=1:length(EMGList)
0226             <span class="keyword">while</span> sum(strcmpi(orderedEMGList,EMGList{k}))==0 &amp;&amp; ~strcmpi(EMGList{k}(1:4),<span class="string">'sync'</span>)
0227                 aux= inputdlg([<span class="string">'Did not recognize muscle name, please re-enter name for channel '</span> num2str(k) <span class="string">' (was '</span> EMGList{k} <span class="string">'). Acceptable values are '</span> cell2mat(strcat(orderedEMGList,<span class="string">', '</span>)) <span class="string">' or ''sync''.'</span>],<span class="string">'s'</span>);
0228                 <span class="keyword">if</span> k&lt;=length(EMGList1)
0229                     info.EMGList1{idxList(k)}=aux{1}; <span class="comment">%This is to keep the same message from being prompeted for each trial processed.</span>
0230                 <span class="keyword">else</span>
0231                     info.EMGList2{idxList2(k-length(EMGList1))}=aux{1};
0232                 <span class="keyword">end</span>
0233                 EMGList{k}=aux{1};
0234             <span class="keyword">end</span>
0235         <span class="keyword">end</span>
0236 
0237         <span class="comment">%For some reasing the naming convention for analog pins is not kept</span>
0238         <span class="comment">%across Nexus versions:</span>
0239         fieldNames=fields(analogs);
0240 
0241         refSync=analogs.(fieldNames{cellfun(@(x) ~isempty(strfind(x,<span class="string">'Pin3'</span>)) | ~isempty(strfind(x,<span class="string">'Pin_3'</span>)) | ~isempty(strfind(x,<span class="string">'Raw_3'</span>)),fieldNames)});
0242 
0243         <span class="comment">%Check for frequencies between the two PCs</span>
0244         <span class="keyword">if</span> secondFile
0245             <span class="keyword">if</span> abs(analogsInfo.frequency-analogsInfo2.frequency)&gt;eps
0246                 warning(<span class="string">'Sampling rates from the two computers are different, down-sampling one under the assumption that sampling rates are multiple of each other.'</span>)
0247                 <span class="comment">%Assuming that the sampling rates are multiples of one another</span>
0248                 <span class="keyword">if</span> analogsInfo.frequency&gt;analogsInfo2.frequency
0249                     <span class="comment">%First set is the up-sampled one, reducing</span>
0250                     P=analogsInfo.frequency/analogsInfo2.frequency;
0251                     R=round(P);
0252                     relData=relData(1:R:<span class="keyword">end</span>,:);
0253                     refSync=refSync(1:R:end);
0254                     EMGfrequency=analogsInfo2.frequency;
0255                 <span class="keyword">else</span>
0256                     P=round(analogsInfo2.frequency/analogsInfo.frequency);
0257                     R=round(P);
0258                     relData2=relData2(1:R:<span class="keyword">end</span>,:);
0259                     EMGfrequency=analogsInfo.frequency;
0260                 <span class="keyword">end</span>
0261                 <span class="keyword">if</span> abs(R-P)&gt;1e-7
0262                     error(<span class="string">'loadTrials:unmatchedSamplingRatesForEMG'</span>,<span class="string">'The different EMG files are sampled at different rates and they are not multiple of one another'</span>)
0263                 <span class="keyword">end</span>
0264             <span class="keyword">else</span>
0265                 EMGfrequency=analogsInfo.frequency;
0266             <span class="keyword">end</span>
0267         <span class="keyword">else</span>
0268             EMGfrequency=analogsInfo.frequency;
0269         <span class="keyword">end</span>
0270 
0271         <span class="comment">%Only keeping matrices of same size to one another:</span>
0272         <span class="keyword">if</span> secondFile
0273             [auxData, auxData2] = truncateToSameLength(relData,relData2);
0274             allData=[auxData,auxData2];
0275             clear auxData*
0276         <span class="keyword">else</span>
0277             allData=relData;
0278         <span class="keyword">end</span>
0279 
0280         <span class="comment">%Pre-process:</span>
0281         [refSync] = clipSignals(refSync(:),.1); <span class="comment">%Clipping top &amp; bottom samples (1 out of 1e3!)</span>
0282         refAux=medfilt1(refSync,20);
0283         <span class="comment">%refAux(refAux&lt;(median(refAux)-5*iqr(refAux)) | refAux&gt;(median(refAux)+5*iqr(refAux)))=median(refAux);</span>
0284         refAux=medfilt1(diff(refAux),10);
0285         clear auxData*
0286 
0287         syncIdx=strncmpi(EMGList,<span class="string">'Sync'</span>,4); <span class="comment">%Compare first 4 chars in string list</span>
0288         sync=allData(:,syncIdx);
0289 
0290         <span class="keyword">if</span> ~isempty(sync) <span class="comment">%Only proceeding with synchronization if there are sync signals</span>
0291             <span class="comment">%Clipping top &amp; bottom 0.1%</span>
0292             [sync] = clipSignals(sync,.1);
0293             N=size(sync,1);
0294             aux=medfilt1(sync,20,[],1); <span class="comment">%Median filter to remove spikes</span>
0295             <span class="comment">%aux(aux&gt;(median(aux)+5*iqr(aux)) | aux &lt;(median(aux)-5*iqr(aux)))=median(aux(:)); %Truncating samples outside the median+-5*iqr range</span>
0296             aux=medfilt1(diff(aux),10,[],1);
0297             <span class="keyword">if</span> secondFile
0298                 [~,timeScaleFactor,lagInSamples,~] = matchSignals(aux(:,1),aux(:,2));
0299 <span class="comment">%                 [~,timeScaleFactor,lagInSamples,~] = matchSignals(refAux,aux(:,2));</span>
0300                 newRelData2 = resampleShiftAndScale(relData2,timeScaleFactor,lagInSamples,1); <span class="comment">%Aligning relData2 to relData1. There is still the need to find the overall delay of the EMG system with respect to forceplate data.</span>
0301             <span class="keyword">end</span>
0302             [~,timeScaleFactorA,lagInSamplesA,~] = matchSignals(refAux,aux(:,1));
0303             newRelData = resampleShiftAndScale(relData,1,lagInSamplesA,1);
0304             <span class="keyword">if</span> secondFile
0305                 newRelData2 = resampleShiftAndScale(newRelData2,1,lagInSamplesA,1);
0306 <span class="comment">%                 [~,timeScaleFactor,lagInSamples,~] = matchSignals(refAux,aux(:,2)); %DMMO and ARL change to deal w aligment</span>
0307 <span class="comment">%                 newRelData2 = resampleShiftAndScale(newRelData2,1,lagInSamples,1);  %DMMO and ARL change to deal w aligment</span>
0308 <span class="comment">% %</span>
0309             <span class="keyword">end</span>
0310 
0311             <span class="comment">%Only keeping matrices of same size to one another:</span>
0312             <span class="keyword">if</span> secondFile
0313                 [auxData, auxData2] = truncateToSameLength(newRelData,newRelData2);
0314                 clear newRelData*
0315                 allData=[auxData,auxData2];
0316                 clear auxData*
0317             <span class="keyword">else</span>
0318                 allData=newRelData;
0319             <span class="keyword">end</span>
0320 
0321             <span class="comment">%Finding gains through least-squares on high-pass filtered synch</span>
0322             <span class="comment">%signals (why using HPF for gains and not for synch?)</span>
0323             [refSync] = clipSignals(refSync(:),.1);
0324             refSync=idealHPF(refSync,0); <span class="comment">%Removing DC only</span>
0325             [allData,refSync]=truncateToSameLength(allData,refSync);
0326             sync=allData(:,syncIdx);
0327             [sync] = clipSignals(sync,.1);
0328             sync=idealHPF(sync,0);
0329             gain1=refSync'/sync(:,1)';
0330             indStart=round(max([lagInSamplesA+1,1]));
0331             reducedRefSync=refSync(indStart:end);
0332             indStart=round(max([lagInSamplesA+1,1]));
0333             reducedSync1=sync(indStart:<span class="keyword">end</span>,1)*gain1;
0334             E1=sum((reducedRefSync-reducedSync1).^2)/sum(refSync.^2); <span class="comment">%Computing error energy as % of original signal energy, only considering the time interval were signals were simultaneously recorded.</span>
0335             <span class="keyword">if</span> secondFile
0336                 gain2=refSync'/sync(:,2)';
0337                 indStart=round(max([lagInSamplesA+1+lagInSamples,1]));
0338                 reducedRefSync2=refSync(indStart:end);
0339 <span class="comment">%                 indStart=round(max([lagInSamplesA+1+lagInSamples,1]));</span>
0340                 reducedSync2=sync(indStart:<span class="keyword">end</span>,2)*gain2;
0341                 E2=sum((reducedRefSync2-reducedSync2).^2)/sum(refSync.^2);
0342                 <span class="comment">%Comparing the two bases' synchrony mechanism (not to ref signal):</span>
0343                 <span class="comment">%reducedSync1a=sync(max([lagInSamplesA+1+lagInSamples,1,lagInSamplesA+1]):end,1)*gain1;</span>
0344                 <span class="comment">%reducedSync2a=sync(max([lagInSamplesA+1+lagInSamples,1,lagInSamplesA+1]):end,2)*gain2;</span>
0345                 <span class="comment">%E3=sum((reducedSync1a-reducedSync2a).^2)/sum(refSync.^2);</span>
0346             <span class="keyword">else</span>
0347                 E2=0;
0348                 gain2=NaN;
0349                 timeScaleFactor=NaN;
0350                 lagInSamples=NaN;
0351             <span class="keyword">end</span>
0352 
0353             <span class="comment">%Analytic measure of alignment problems</span>
0354             disp([<span class="string">'Sync complete: mismatch signal energy (as %) was '</span> num2str(100*E1,3) <span class="string">' and '</span> num2str(100*E2,3) <span class="string">'.'</span>])
0355             disp([<span class="string">'Sync parameters to ref. signal were: gains= '</span> num2str(gain1,4) <span class="string">', '</span> num2str(gain2,4) <span class="string">'; delays= '</span> num2str(lagInSamplesA/EMGfrequency,3) <span class="string">'s, '</span> num2str((lagInSamplesA+lagInSamples)/EMGfrequency,3) <span class="string">'s'</span>]);
0356             disp([<span class="string">'Typical sync parameters are: gains= -933.3 +- 0.2 (both); delays= -0.025s +- 0.001, 0.014 +- 0.002'</span>])
0357             disp([<span class="string">'Sync parameters between PCs were: gain= '</span> num2str(gain1/gain2,4) <span class="string">'; delay= '</span> num2str((lagInSamples)/EMGfrequency,3) <span class="string">'s; sampling mismatch (ppm)= '</span> num2str(1e6*(1-timeScaleFactor),3)]);
0358             disp([<span class="string">'Typical sync parameters are: gain= 1; delay= 0.040s; sampling= 35 ppm'</span>])
0359             <span class="keyword">if</span> isnan(E1) || isnan(E2) || E1&gt;.01 || E2&gt;.01 <span class="comment">%Signal difference has at least 1% of original signal energy</span>
0360                 warning([<span class="string">'Time alignment doesnt seem to have worked: signal mismatch is too high in trial '</span> num2str(t) <span class="string">'.'</span>])
0361                 h=figure;
0362                 subplot(2,2,[1:2])
0363                 hold on
0364                 title([<span class="string">'Trial '</span> num2str(t) <span class="string">' Synchronization'</span>])
0365                 time=[0:length(refSync)-1]*1/EMGfrequency;
0366                 plot(time,refSync)
0367                 plot(time,sync(:,1)*gain1,<span class="string">'r'</span>)
0368                 <span class="keyword">if</span> secondFile
0369                     plot(time,sync(:,2)*gain2,<span class="string">'g'</span>)
0370                 <span class="keyword">end</span>
0371                 leg1=[<span class="string">'sync1, delay='</span> num2str(lagInSamplesA/EMGfrequency,3) <span class="string">'s, gain='</span> num2str(gain1,4) <span class="string">', mismatch(%)='</span> num2str(100*E1,3)];
0372                 leg2=[<span class="string">'sync2, delay='</span> num2str((lagInSamplesA+lagInSamples)/EMGfrequency,3) <span class="string">'s, gain='</span> num2str(gain2,4) <span class="string">', mismatch(%)='</span> num2str(100*E2,3)];
0373                 legend(<span class="string">'refSync'</span>,leg1,leg2)
0374                 hold off
0375                 subplot(2,2,3)
0376                 T=round(3*EMGfrequency); <span class="comment">%To plot just 3 secs at the beginning and at the end</span>
0377                 <span class="keyword">if</span> T&lt;length(refSync)
0378                     hold on
0379                     plot(time(1:T),refSync(1:T))
0380                     plot(time(1:T),sync(1:T,1)*gain1,<span class="string">'r'</span>)
0381                     <span class="keyword">if</span> secondFile
0382                         plot(time(1:T),sync(1:T,2)*gain2,<span class="string">'g'</span>)
0383                     <span class="keyword">end</span>
0384                     hold off
0385                     subplot(2,2,4)
0386                     hold on
0387                     plot(time(end-T:end),refSync(end-T:end))
0388                     plot(time(end-T:end),sync(end-T:<span class="keyword">end</span>,1)*gain1,<span class="string">'r'</span>)
0389                     <span class="keyword">if</span> secondFile
0390                         plot(time(end-T:end),sync(end-T:<span class="keyword">end</span>,2)*gain2,<span class="string">'g'</span>)
0391                     <span class="keyword">end</span>
0392                     hold off
0393                 <span class="keyword">end</span>
0394                 s=inputdlg(<span class="string">'If sync parameters between signals look fine and mismatch is below 5%, we recommend yes.'</span>,<span class="string">'Please confirm that you want to proceed like this (y/n).'</span>);
0395                 <span class="keyword">switch</span> s{1}
0396                     <span class="keyword">case</span> {<span class="string">'y'</span>,<span class="string">'Y'</span>,<span class="string">'yes'</span>}
0397                         disp([<span class="string">'Using signals in a possibly unsynchronized way!.'</span>])
0398                         close(h)
0399                     <span class="keyword">case</span> {<span class="string">'n'</span>,<span class="string">'N'</span>,<span class="string">'no'</span>}
0400                         error(<span class="string">'loadTrials:EMGCouldNotBeSynched'</span>,<span class="string">'Could not synchronize EMG data, stopping data loading.'</span>)
0401                 <span class="keyword">end</span>
0402             <span class="keyword">end</span>
0403 
0404             <span class="comment">%Plot to CONFIRM VISUALLY if alignment worked:</span>
0405             h=figure;
0406             subplot(2,2,[1:2])
0407             hold on
0408             title([<span class="string">'Trial '</span> num2str(t) <span class="string">' Synchronization'</span>])
0409             time=[0:length(refSync)-1]*1/EMGfrequency;
0410             plot(time,refSync)
0411             plot(time,sync(:,1)*gain1,<span class="string">'r'</span>)
0412             leg1=[<span class="string">'sync1, delay='</span> num2str(lagInSamplesA/EMGfrequency,3) <span class="string">'s, gain='</span> num2str(gain1,4) <span class="string">', mismatch(%)='</span> num2str(100*E1,3)];
0413             <span class="keyword">if</span> secondFile
0414                 plot(time,sync(:,2)*gain2,<span class="string">'g'</span>)
0415                 leg2=[<span class="string">'sync2, delay='</span> num2str((lagInSamplesA+lagInSamples)/EMGfrequency,3) <span class="string">'s, gain='</span> num2str(gain2,4) <span class="string">', mismatch(%)='</span> num2str(100*E2,3)];
0416                 legend(<span class="string">'refSync'</span>,leg1,leg2)
0417             <span class="keyword">else</span>
0418                 legend(<span class="string">'refSync'</span>,leg1)
0419             <span class="keyword">end</span>
0420             hold off
0421             subplot(2,2,3)
0422             T=round(3*EMGfrequency); <span class="comment">%To plot just 3 secs at the beginning and at the end</span>
0423             <span class="keyword">if</span> T&lt;length(refSync)
0424                 hold on
0425                 plot(time(1:T),refSync(1:T))
0426                 plot(time(1:T),sync(1:T,1)*gain1,<span class="string">'r'</span>)
0427                 <span class="keyword">if</span> secondFile
0428                     plot(time(1:T),sync(1:T,2)*gain2,<span class="string">'g'</span>)
0429                 <span class="keyword">end</span>
0430                 <span class="comment">%legend('refSync',['sync1, delay=' num2str(lagInSamplesA/analogsInfo.frequency,3) 's'],['sync2, delay=' num2str((lagInSamplesA+lagInSamples)/analogsInfo.frequency,3)  's'])</span>
0431                 hold off
0432                 subplot(2,2,4)
0433                 hold on
0434                 plot(time(end-T:end),refSync(end-T:end))
0435                 plot(time(end-T:end),sync(end-T:<span class="keyword">end</span>,1)*gain1,<span class="string">'r'</span>)
0436                 <span class="keyword">if</span> secondFile
0437                     plot(time(end-T:end),sync(end-T:<span class="keyword">end</span>,2)*gain2,<span class="string">'g'</span>)
0438                 <span class="keyword">end</span>
0439                 <span class="comment">%legend('refSync',['sync1, delay=' num2str(lagInSamplesA/analogsInfo.frequency,3) 's'],['sync2, delay=' num2str((lagInSamplesA+lagInSamples)/analogsInfo.frequency,3)  's'])</span>
0440                 hold off
0441             <span class="keyword">end</span>
0442             saveFig(h,<span class="string">'./'</span>,[<span class="string">'Trial '</span> num2str(t) <span class="string">' Synchronization'</span>])
0443             <span class="comment">%         uiwait(h)</span>
0444         <span class="keyword">else</span>
0445             warning(<span class="string">'No sync signals were present, using data as-is.'</span>)
0446         <span class="keyword">end</span>
0447 
0448 
0449         <span class="comment">%Sorting muscles (orderedEMGList was created previously) so that they are always stored in the same order</span>
0450         orderedIndexes=zeros(length(orderedEMGList),1);
0451         <span class="keyword">for</span> j=1:length(orderedEMGList)
0452             <span class="keyword">for</span> k=1:length(EMGList)
0453                 <span class="keyword">if</span> strcmpi(orderedEMGList{j},EMGList{k})
0454                     orderedIndexes(j)=k;
0455                     <span class="keyword">break</span>;
0456                 <span class="keyword">end</span>
0457             <span class="keyword">end</span>
0458         <span class="keyword">end</span>
0459         orderedIndexes=orderedIndexes(orderedIndexes~=0); <span class="comment">%Avoiding missing muscles</span>
0460         aux=zeros(length(EMGList),1);
0461         aux(orderedIndexes)=1;
0462         <span class="keyword">if</span> any(aux==0) &amp;&amp; ~all(strcmpi(EMGList(aux==0),<span class="string">'sync'</span>))
0463             warning([<span class="string">'loadTrials: Not all of the provided muscles are in the ordered list, ignoring '</span> EMGList{aux==0}])
0464         <span class="keyword">end</span>
0465         allData(allData==0)=NaN; <span class="comment">%Eliminating samples that are exactly 0: these are unavailable samples</span>
0466         EMGData=labTimeSeries(allData(:,orderedIndexes),0,1/EMGfrequency,EMGList(orderedIndexes)); <span class="comment">%Throw away the synch signal</span>
0467         clear allData* relData* auxData*
0468 
0469         <span class="comment">%% AccData (from 2 files too!)</span>
0470         <span class="comment">%Primary file</span>
0471         <span class="keyword">if</span> info.Nexus==1
0472 
0473             relData=[];
0474             idxList=[];
0475             fieldList=fields(analogs);
0476             <span class="keyword">for</span> j=1:length(fieldList)
0477                 <span class="keyword">if</span> ~isempty(strfind(fieldList{j},<span class="string">'ACC'</span>))  <span class="comment">%Getting fields that start with 'ACC' only</span>
0478                     idxList(j)=str2num(fieldList{j}(strfind(fieldList{j},<span class="string">'ACC'</span>)+4:end));
0479                     <span class="keyword">switch</span> fieldList{j}(strfind(fieldList{j},<span class="string">'ACC'</span>)+3)
0480                         <span class="keyword">case</span> <span class="string">'X'</span>
0481                             aux=1;
0482                         <span class="keyword">case</span> <span class="string">'Y'</span>
0483                             aux=2;
0484                         <span class="keyword">case</span> <span class="string">'Z'</span>
0485                             aux=3;
0486                     <span class="keyword">end</span>
0487                     eval([<span class="string">'relData(:,idxList(j),aux)=analogs.'</span> fieldList{j} <span class="string">';'</span>]);
0488                     analogs=rmfield(analogs,fieldList{j}); <span class="comment">%Just to save memory space</span>
0489                 <span class="keyword">end</span>
0490             <span class="keyword">end</span>
0491             relData=permute(relData(:,~emptyChannels1,:),[1,3,2]);
0492             relData=relData(:,:);
0493             <span class="keyword">if</span> EMGfrequency~=analogsInfo.frequency <span class="comment">%The frequency was changed when downsampling EMG data</span>
0494                 P=analogsInfo.frequency/EMGfrequency;
0495                 R=round(P);
0496                 relData=relData(1:R:<span class="keyword">end</span>,:);
0497             <span class="keyword">end</span>
0498             <span class="comment">%Fixing time alignment</span>
0499             <span class="keyword">if</span> ~isempty(sync)
0500                 relData = resampleShiftAndScale(relData,1,lagInSamplesA,1);
0501             <span class="keyword">end</span>
0502 
0503 
0504             <span class="comment">%Secondary file</span>
0505             relData2=[];
0506             idxList2=[];
0507             <span class="keyword">if</span> secondFile
0508                 fieldList=fields(analogs2);
0509                 <span class="keyword">for</span> j=1:length(fieldList)
0510                     <span class="keyword">if</span> ~isempty(strfind(fieldList{j},<span class="string">'ACC'</span>))  <span class="comment">%Getting fields that start with 'EMG' only</span>
0511                         idxList2(j)=str2num(fieldList{j}(strfind(fieldList{j},<span class="string">'ACC'</span>)+4:end));
0512                         <span class="keyword">switch</span> fieldList{j}(strfind(fieldList{j},<span class="string">'ACC'</span>)+3)
0513                             <span class="keyword">case</span> <span class="string">'X'</span>
0514                                 aux=1;
0515                             <span class="keyword">case</span> <span class="string">'Y'</span>
0516                                 aux=2;
0517                             <span class="keyword">case</span> <span class="string">'Z'</span>
0518                                 aux=3;
0519                         <span class="keyword">end</span>
0520                         eval([<span class="string">'relData2(:,idxList2(j),aux)=analogs2.'</span> fieldList{j} <span class="string">';'</span>]);
0521                         analogs2=rmfield(analogs2,fieldList{j}); <span class="comment">%Just to save memory space</span>
0522                     <span class="keyword">end</span>
0523                 <span class="keyword">end</span>
0524                 relData2=permute(relData2(:,~emptyChannels2,:),[1,3,2]);
0525                 relData2=relData2(:,:);
0526                 <span class="keyword">if</span> EMGfrequency~=analogsInfo2.frequency <span class="comment">%The frequency was changed when downsampling EMG data</span>
0527                     P=analogsInfo2.frequency/EMGfrequency;
0528                     R=round(P);
0529                     relData2=relData2(1:R:<span class="keyword">end</span>,:);
0530                 <span class="keyword">end</span>
0531                 <span class="comment">%Fixing time alignment</span>
0532                 <span class="keyword">if</span> ~isempty(sync)
0533                     relData2 = resampleShiftAndScale(relData2,timeScaleFactor,lagInSamples,1); <span class="comment">%Aligning relData2 to relData1. There is still the need to find the overall delay of the EMG system with respect to forceplate data.</span>
0534                     relData2 = resampleShiftAndScale(relData2,1,lagInSamplesA,1);
0535                     [auxData, auxData2] = truncateToSameLength(relData,relData2);
0536                     clear relData*
0537                     allData=[auxData,auxData2];
0538                     clear auxData*
0539                 <span class="keyword">else</span>
0540                     allData=[relData,relData2]; <span class="comment">%No synch, two files</span>
0541                 <span class="keyword">end</span>
0542             <span class="keyword">else</span>
0543                 allData=relData;
0544             <span class="keyword">end</span>
0545 
0546             <span class="comment">%Throwing away empty fields (same that were thrown on EMG data)</span>
0547 
0548             <span class="comment">% Assign names:</span>
0549             ACCList={};
0550             <span class="keyword">for</span> j=1:length(EMGList)
0551                 ACCList{end+1}=[EMGList{j} <span class="string">'x'</span>];
0552                 ACCList{end+1}=[EMGList{j} <span class="string">'y'</span>];
0553                 ACCList{end+1}=[EMGList{j} <span class="string">'z'</span>];
0554             <span class="keyword">end</span>
0555 
0556             accData=orientedLabTimeSeries(allData(1:13:<span class="keyword">end</span>,:),0,13/EMGfrequency,ACCList,orientation); <span class="comment">%Downsampling to ~150Hz, which is much closer to the original 148Hz sampling rate (where does this get upsampled? why?)</span>
0557             <span class="comment">% orientation is fake: orientation is local and unique to each sensor, which is affixed to a body segment.</span>
0558         <span class="keyword">elseif</span> info.EMGworks==1
0559 
0560 <span class="comment">%             [ACCList, allData,analogsInfo]=getEMGworksdataAcc(info.EMGList2 ,info.secEMGworksdir_location,info.EMGworksdir_location,fileList{t},emptyChannels1,emptyChannels2,EMGList);</span>
0561 <span class="comment">%             Samplingfrequency=analogsInfo.frequency;</span>
0562             accData=[];<span class="comment">%orientedLabTimeSeries(allData(1:13:end,:),0,Samplingfrequency,ACCList,orientation);</span>
0563         <span class="keyword">end</span>
0564         clear allData* relData* auxData*
0565     <span class="keyword">else</span>
0566         EMGData=[];
0567         accData=[];
0568     <span class="keyword">end</span>
0569    
0570     <span class="comment">%% Add H-Reflex Stimulator Pin if exists (new expeirmental feature introduced in April 2024)</span>
0571     relData=[];
0572     stimLabels ={};
0573     units={};
0574     fieldList=fields(analogs);
0575     stimLabelIdx=cellfun(@(x) ~isempty(x),regexp(fieldList,<span class="string">'^Stimulator_Trigger_Sync_'</span>));
0576     stimLabelIdx = find(stimLabelIdx);
0577     <span class="keyword">if</span> ~isempty(stimLabelIdx)
0578         <span class="keyword">for</span> j=1:length(stimLabelIdx) <span class="comment">%this will only run if the index exists</span>
0579             stimLabels{end+1} = fieldList{stimLabelIdx(j)}; <span class="comment">%add the label</span>
0580             units{end+1}=eval([<span class="string">'analogsInfo.units.'</span>,fieldList{stimLabelIdx(j)}]);
0581             relData=[relData,analogs.(fieldList{stimLabelIdx(j)})];
0582         <span class="keyword">end</span>
0583         HreflexStimPinData = labTimeSeries(relData,0,1/analogsInfo.frequency,stimLabels);
0584         <span class="comment">%arg: data, t0 (offset in starting of the data, should be 0 like the force plates, as it's analog wired stream into Vicon?),</span>
0585         <span class="comment">%Ts (1/sampling frequency), labels</span>
0586 
0587         <span class="comment">%sanity check, the # of frames should match GRF data</span>
0588         <span class="keyword">if</span> (GRFData.Length ~= HreflexStimPinData.Length)
0589             error(<span class="string">'Hreflex stimulator pin have different length than GRF data. This should never happen. Data is compromised.'</span>)
0590         <span class="keyword">end</span>
0591     <span class="keyword">else</span>
0592         <span class="comment">%This is needed to work with expeirments that doesn't have this pin.</span>
0593         HreflexStimPinData = [];
0594     <span class="keyword">end</span>
0595     
0596     
0597     <span class="comment">%% MarkerData</span>
0598     clear analogs* <span class="comment">%Save memory space, no longer need analog data, it was already loaded</span>
0599     <span class="keyword">if</span> info.kinematics <span class="comment">%check to see if there is kinematic data</span>
0600         [markers,markerInfo]=btkGetMarkers(H);
0601         relData=[];
0602         fieldList=fields(markers);
0603         markerList={};
0604 
0605         <span class="comment">%Check marker labels are good in .c3d files</span>
0606         mustHaveLabels={<span class="string">'LHIP'</span>,<span class="string">'RHIP'</span>,<span class="string">'LANK'</span>,<span class="string">'RANK'</span>,<span class="string">'RHEE'</span>,<span class="string">'LHEE'</span>,<span class="string">'LTOE'</span>,<span class="string">'RTOE'</span>,<span class="string">'RKNE'</span>,<span class="string">'LKNE'</span>};<span class="comment">%we don't really care if there is RPSIS RASIS LPSIS LASIS or anything else really</span>
0607         labelPresent=false(1,length(mustHaveLabels));
0608         <span class="keyword">for</span> i=1:length(fieldList)
0609             newFieldList{i}=<a href="findLabel.html" class="code" title="function markerLabel=findLabel(viconLabel)">findLabel</a>(fieldList{i});
0610             labelPresent=labelPresent+ismember(mustHaveLabels,newFieldList{i});
0611         <span class="keyword">end</span>
0612 
0613         <span class="comment">%         %if any of the must-have labels are not present, terminate script</span>
0614         <span class="comment">%         %and throw warning.</span>
0615         <span class="comment">%         if any(~labelPresent)</span>
0616         <span class="comment">%             missingLabels=find(~labelPresent);</span>
0617         <span class="comment">%             str=' ';</span>
0618         <span class="comment">%             for j=missingLabels</span>
0619         <span class="comment">%                 str=[str ', ' mustHaveLabels{j}];</span>
0620         <span class="comment">%             end</span>
0621         <span class="comment">%             ME=MException('loadTrials:markerDataError',['Marker data does not contain:' str '. Edit ''findLabel'' code to fix.']);</span>
0622         <span class="comment">%             throw(ME)</span>
0623         <span class="comment">%         end</span>
0624 
0625         <span class="comment">%atlernatively,</span>
0626         <span class="keyword">if</span> any(~labelPresent)
0627             missingLabels=find(~labelPresent);
0628             potentialMatches=newFieldList(~ismember(newFieldList,mustHaveLabels));
0629             <span class="keyword">for</span> j=missingLabels
0630                 <span class="comment">%generate menu</span>
0631                 choice = menu([{[<span class="string">'WARNING: the marker label '</span> mustHaveLabels{j}]},{<span class="string">' was not found, but is necessary for'</span>},<span class="keyword">...</span>
0632                     {<span class="string">'future calculations.Please indicate which'</span>},{[<span class="string">' marker corresponds to the '</span> mustHaveLabels{j} <span class="string">' label:'</span>]}] ,[potentialMatches {<span class="string">'NaN'</span>}]);
0633                 <span class="keyword">if</span> choice==0
0634                     ME=MException(<span class="string">'loadTrials:markerDataError'</span>,<span class="string">'Operation terminated by user while finding names of necessary labels.'</span>);
0635                     throw(ME)
0636                 <span class="keyword">elseif</span> choice&gt;length(potentialMatches)
0637                     <span class="comment">%nop</span>
0638                     warning(<span class="string">'loadTrials:missingRequiredMarker'</span>,[<span class="string">'A required marker ('</span> mustHaveLabels{j} <span class="string">') was missing from the marker list. This will be problematic when computing parameters.'</span>])
0639                 <span class="keyword">else</span>
0640                     <span class="comment">%set the label corresponding to choice as one of the must-have labels</span>
0641                     <a href="addMarkerPair.html" class="code" title="function addMarkerPair(correctLabel,altLabel)">addMarkerPair</a>(mustHaveLabels{j},potentialMatches{choice})
0642                 <span class="keyword">end</span>
0643             <span class="keyword">end</span>
0644         <span class="keyword">end</span>
0645 
0646         <span class="keyword">for</span> j=1:length(fieldList)
0647             <span class="keyword">if</span> length(fieldList{j})&gt;2 &amp;&amp; ~strcmp(fieldList{j}(1:2),<span class="string">'C_'</span>)  <span class="comment">%Getting fields that do NOT start with 'C_' (they correspond to unlabeled markers in Vicon naming)</span>
0648                 relData=[relData,markers.(fieldList{j})];
0649                 markerLabel=<a href="findLabel.html" class="code" title="function markerLabel=findLabel(viconLabel)">findLabel</a>(fieldList{j});<span class="comment">%make sure that the markers are always named the same after this point (ex - if left hip marker is labeled LGT, LHIP, or anyhting else it always becomes LHIP.)</span>
0650                 markerList{end+1}=[markerLabel <span class="string">'x'</span>];
0651                 markerList{end+1}=[markerLabel <span class="string">'y'</span>];
0652                 markerList{end+1}=[markerLabel <span class="string">'z'</span>];
0653             <span class="keyword">end</span>
0654             markers=rmfield(markers,fieldList{j}); <span class="comment">%Save memory</span>
0655         <span class="keyword">end</span>
0656         relData(relData==0)=NaN; <span class="comment">%This forces missing labels to be labeled as NaN</span>
0657         markerData=orientedLabTimeSeries(relData,0,1/markerInfo.frequency,markerList,orientation);
0658         clear relData
0659         markerData.DataInfo.Units=markerInfo.units.ALLMARKERS;
0660     <span class="keyword">else</span>
0661         markerData=[];
0662     <span class="keyword">end</span>
0663 
0664     
0665     <span class="comment">%% Construct trialData</span>
0666 
0667     <span class="comment">%rawTrialData(metaData,markerData,EMGData,GRFData,beltSpeedSetData,beltSpeedReadData,accData,EEGData,footSwitches)</span>
0668     trials{t}=rawTrialData(trialMD{t},markerData,EMGData,GRFData,[],[],accData,[],[],HreflexStimPinData);<span class="comment">%organize trial data into organized object of class rawTrialData</span>
0669 
0670 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 16-Apr-2024 13:38:03 by <strong><a href="https://github.com/gllmflndn/m2html">m2html</a></strong> &copy; 2003-2022</address>
</body>
</html>